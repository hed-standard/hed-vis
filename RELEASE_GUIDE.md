# HED-Vis Release Guide

This document provides step-by-step instructions for releasing a new version of hedvis to PyPI.

**Platform Support:** This guide includes commands for both Windows (PowerShell) and Linux/macOS (Bash).

## Prerequisites

Before starting the release process, ensure you have:

- [ ] Write access to the hed-vis repository (maintainer/collaborator)
- [ ] PyPI account with maintainer access to the `hedvis` package
- [ ] Git configured with your credentials
- [ ] Python 3.10+ installed
- [ ] Virtual environment activated (if using one)
- [ ] Your fork of hed-vis set up as `origin` remote
- [ ] hed-standard/hed-vis set up as `upstream` remote
- [ ] All intended changes merged to the `main` branch of upstream

**Git remote setup:**

If you haven't set up your remotes, run:

```bash
# Check your current remotes
git remote -v

# If needed, add upstream (assuming origin is your fork)
git remote add upstream https://github.com/hed-standard/hed-vis.git
```

Your setup should look like:

- `origin` → your fork (e.g., `yourusername/hed-vis`)
- `upstream` → `hed-standard/hed-vis`

## Release Checklist

### 1. Pre-Release Preparation

#### 1.1 Ensure Working Tree is Clean

**Windows (PowerShell):**

```powershell
# Check git status
git status

# If there are uncommitted changes, commit or stash them
git add .
git commit -m "Pre-release cleanup"
```

**Linux/macOS (Bash):**

```bash
# Check git status
git status

# If there are uncommitted changes, commit or stash them
git add .
git commit -m "Pre-release cleanup"
```

#### 1.2 Update CHANGELOG.md

Add a new entry at the top of `CHANGELOG.md` with:

- Release version number (e.g., "Release 0.1.1")
- Release date
- Bullet points describing:
  - New features
  - Enhancements
  - Bug fixes
  - Documentation improvements
  - Breaking changes (if any)

**Recommend asking Copilot to produce a draft change log reflecting changes between the last release and the current commit on the main branch.**

**Example:**

```markdown
Release 0.1.1 January 26, 2026
- Applied Black code formatter to entire codebase for consistent code style
- Added Black to development dependencies and CI workflow
- Enhanced CONTRIBUTING.md with code formatting guidelines
- Updated README.md with Black usage instructions
```

#### 1.3 Run Code Quality Checks

Before releasing, ensure all code quality checks pass:

**All Platforms:**

```bash
# Run code formatter check
black --check .
# On Windows, use: black --workers 1 --check .

# Run linter (if applicable)
# ruff check hedvis/ tests/

# Run spell checker
codespell

# Run all tests
python -m unittest discover tests -v
```

Fix any issues before proceeding.

#### 1.4 Commit CHANGELOG Updates

**All Platforms:**

```bash
git add CHANGELOG.md
git commit -m "Update CHANGELOG for version 0.1.1"
```

#### 1.5 Push CHANGELOG to Your Fork and Create Pull Request

Push your changes to your fork and create a pull request to upstream:

**All Platforms:**

```bash
# Push to your fork (origin)
git push origin your-feature-branch

# OR if you're working directly on main in your fork:
git push origin main
```

**Create pull request:**

1. Go to your fork on GitHub: `https://github.com/yourusername/hed-vis`
2. Click **"Contribute"** → **"Open pull request"**
3. Target: `hed-standard/hed-vis` (base: `main`)
4. Source: Your fork and branch
5. Title: "Update CHANGELOG for version 0.1.1" (or similar)
6. Create and merge the pull request

**Important:** Ensure the CHANGELOG updates are merged into the upstream `main` branch (hed-standard/hed-vis) before proceeding.

### 2. Create GitHub Release

The project uses version management via pyproject.toml. We'll create the release tag and release directly on GitHub.

#### 2.1 Navigate to Create Release

Go to: https://github.com/hed-standard/hed-vis/releases/new

#### 2.2 Create Release Tag and Release

Fill in the release form:

1. **Choose a tag:** Type a new tag: `0.1.0`

   - **Target:** main branch
   - Use semantic versioning: MAJOR.MINOR.PATCH
   - Do NOT use a prefix (e.g., use `0.1.0`, not `v0.1.0`)

2. **Release title:** `Release 0.1.0`

3. **Description:** Paste the detailed changelog information generated by Copilot

**Example description:**

```markdown
## What's New in 0.1.0

### Features
- Added word cloud generation with customizable colors and masks
- Enhanced tag visualization with sequence mapping
- Added comprehensive visualization configuration options

### Documentation
- Added comprehensive CONTRIBUTING.md with development guidelines
- Significantly enhanced README.md with better documentation structure
- Improved user guide documentation

### Bug Fixes
- Fixed image mask handling for word clouds
- Fixed typos and improved code documentation

### Full Changelog
See [CHANGELOG.md](https://github.com/hed-standard/hed-vis/blob/main/CHANGELOG.md)
```

4. **Set as latest release:** Check this box

5. Click **Publish release**

#### 2.3 Verify GitHub Release

Verify the release on GitHub:

- [ ] Release appears at https://github.com/hed-standard/hed-vis/releases
- [ ] Tag `0.1.0` was created
- [ ] Release notes display correctly
- [ ] Target is set to main branch

### 3. Verify Zenodo Release (if configured)

If Zenodo integration is enabled, Zenodo automatically creates a DOI and archives the release when a GitHub release is published.

#### 3.1 Check Zenodo Release

**Wait a few minutes** after creating the GitHub release for Zenodo to process it.

1. Check if hed-vis has a Zenodo record (contact repository maintainer if unsure)
2. Verify that a new version appears for your release
3. Check that the DOI is generated
4. Confirm the metadata is correct (title, authors, description)

**Note:** If the Zenodo release doesn't appear after 10-15 minutes, check the GitHub-Zenodo integration settings or contact a repository maintainer.

### 4. Pull Release Tag to Local Repository

Now that the release is created on GitHub, pull the tag to your local repository.

#### 4.1 Update Local Repository from Upstream

**All Platforms:**

```bash
# Switch to main branch
git checkout main

# Pull the latest changes from upstream (hed-standard/hed-vis)
git pull upstream main

# Fetch all tags from upstream
git fetch upstream --tags

# Verify the tag exists locally
git tag -l 0.1.0

# Optional: Update your fork's main branch
git push origin main
```

#### 4.2 Update pyproject.toml Version

Before building, update the version in `pyproject.toml`:

**All Platforms:**

```bash
# Edit pyproject.toml and update the version line:
# version = "0.1.0"
```

Commit this change:

```bash
git add pyproject.toml
git commit -m "Bump version to 0.1.0"
git push upstream main
```

#### 4.3 Verify Version

**All Platforms:**

```bash
# Check that the version is correctly set
python -c "import hedvis; print(hedvis.__version__)"
```

Expected output: `0.1.0`

### 5. Build Distribution Packages

- Release date
- Bullet points describing:
  - New features
  - Enhancements
  - Bug fixes
  - Documentation improvements
  - Breaking changes (if any)

**Example:**

```markdown
Release 0.7.1 October 13, 2025
- Applied Black code formatter to entire codebase for consistent code style
- Added Black to development dependencies and CI workflow
- Enhanced CONTRIBUTING.md with code formatting guidelines
- Updated README.md with Black usage instructions
```

#### 1.3 Run Code Quality Checks

Before releasing, ensure all code quality checks pass:

**All Platforms:**

```bash
# Run code formatter check
black --check .
# On Windows, use: black --workers 1 --check .

# Run linter
ruff check hed/ tests/

# Run spell checker
codespell

# Run all tests
python -m unittest discover tests -v
```

Fix any issues before proceeding.

#### 1.4 Commit CHANGELOG Updates

**All Platforms:**

```bash
git add CHANGELOG.md
git commit -m "Update CHANGELOG for version 0.7.1"
```

#### 1.5 Merge to Main Branch

If you're working on a feature branch:

**All Platforms:**

```bash
# Update your local main branch
git checkout main
git pull origin main

# Merge your feature branch
git merge your-feature-branch

# Resolve any conflicts if they arise
# Then push to origin
git push origin main
```

### 2. Version Tagging

The project uses [versioneer](https://github.com/python-versioneer/python-versioneer) for version management, which automatically derives the version from git tags.

#### 2.1 Create Annotated Tag

**All Platforms:**

```bash
# Create an annotated tag with the version number
git tag -a 0.7.0 -m "Release version 0.7.0"
```

**Important:**

- Use semantic versioning: MAJOR.MINOR.PATCH
- Do NOT use a prefix (e.g., use `0.7.0`, not `v0.7.0`)
- The tag name must match the version you want to release

#### 2.2 Push the Tag

**All Platforms:**

```bash
# Push the tag to the remote repository
git push origin 0.7.0
```

#### 2.3 Verify Version

**All Platforms:**

```bash
# Check that the version is correctly detected
python -c "import hed; print(hed.__version__)"
```

Expected output: `0.7.0`

If you see something like `0+untagged.xxx.gxxxxxxx`, the tag wasn't properly created or you need to pull the tags:

**All Platforms:**

```bash
git fetch --tags
```

### 3. Build Distribution Packages

#### 3.1 Clean Previous Builds

**Windows (PowerShell):**

```powershell
# Remove old build artifacts
Remove-Item -Recurse -Force dist, build, *.egg-info -ErrorAction SilentlyContinue
```

**Linux/macOS (Bash):**

```bash
# Remove old build artifacts
rm -rf dist build *.egg-info
```

#### 3.2 Install/Upgrade Build Tools

**All Platforms:**

```bash
python -m pip install --upgrade build twine
```

#### 3.3 Build the Packages

**All Platforms:**

```bash
# Build both wheel and source distributions
python -m build
```

This creates:

- `dist/hedvis-0.1.0-py3-none-any.whl` (wheel distribution)
- `dist/hedvis-0.1.0.tar.gz` (source distribution)

#### 3.4 Verify Build Contents

**Windows (PowerShell):**

```powershell
# List contents of the wheel
python -m zipfile -l dist/hedvis-0.1.0-py3-none-any.whl

# Check the source distribution (requires tar in PATH)
tar -tzf dist/hedvis-0.1.0.tar.gz
```

**Linux/macOS (Bash):**

```bash
# List contents of the wheel
unzip -l dist/hedvis-0.1.0-py3-none-any.whl

# Check the source distribution
tar -tzf dist/hedvis-0.1.0.tar.gz
```

### 4. Test the Distribution (Recommended)

#### 4.1 Create Test Environment

**Windows (PowerShell):**

```powershell
# Create a fresh virtual environment for testing
python -m venv test_env
.\test_env\Scripts\Activate.ps1
```

**Linux/macOS (Bash):**

```bash
# Create a fresh virtual environment for testing
python -m venv test_env
source test_env/bin/activate
```

#### 4.2 Install from Wheel

**All Platforms:**

```bash
# Install the built wheel
pip install dist/hedvis-0.1.0-py3-none-any.whl
```

#### 4.3 Run Tests

**Windows (PowerShell):**

```powershell
# Navigate back to the repository
cd h:\Repos\hed-vis

# Run the test suite
python -m unittest discover tests -v
```

**Linux/macOS (Bash):**

```bash
# Navigate back to the repository
cd ~/path/to/hed-vis

# Run the test suite
python -m unittest discover tests -v
```

#### 4.4 Verify Installation

**All Platforms:**

```bash
# Check version
python -c "import hedvis; print(hedvis.__version__)"

# Test a basic import
python -c "from hedvis import create_wordcloud; print('Success!')"
```

#### 4.5 Clean Up Test Environment

**Windows (PowerShell):**

```powershell
deactivate
Remove-Item -Recurse -Force test_env
```

**Linux/macOS (Bash):**

```bash
deactivate
rm -rf test_env
```

### 5. Upload to PyPI

#### 5.1 Check Distribution with Twine

**All Platforms:**

```bash
# Validate the distribution packages
python -m twine check dist/*
```

Expected output: `Checking dist/hedvis-0.1.0.tar.gz: PASSED` (and same for .whl)

#### 5.2 Upload to Test PyPI (Optional but Recommended)

**All Platforms:**

```bash
# Upload to TestPyPI first
python -m twine upload --repository testpypi dist/*
```

You'll be prompted for your TestPyPI credentials.

**Test installation from TestPyPI:**

```bash
pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ hedvis==0.1.0
```

#### 5.3 Upload to Production PyPI

**All Platforms:**

```bash
# Upload to the real PyPI
python -m twine upload dist/*
```

You'll be prompted for your PyPI credentials (or use an API token).

**Alternative with API Token:**

*Windows (PowerShell):*

```powershell
# Set your PyPI API token as an environment variable
$env:TWINE_USERNAME = "__token__"
$env:TWINE_PASSWORD = "pypi-your-api-token-here"

# Upload
python -m twine upload dist/*
```

*Linux/macOS (Bash):*

```bash
# Set your PyPI API token as an environment variable
export TWINE_USERNAME="__token__"
export TWINE_PASSWORD="pypi-your-api-token-here"

# Upload
python -m twine upload dist/*
```

#### 5.4 Verify on PyPI

Visit https://pypi.org/project/hedvis/ and verify:

- [ ] Version 0.1.0 is listed
- [ ] README renders correctly
- [ ] All metadata is correct
- [ ] Download links work

### 6. Create GitHub Release

#### 6.1 Navigate to Releases

Go to: https://github.com/hed-standard/hed-vis/releases/new

#### 6.2 Create Release

Fill in the release form:

- **Choose a tag:** Select `0.1.0` from the dropdown
- **Release title:** `Release 0.1.0`
- **Description:** Copy the relevant section from CHANGELOG.md

**Example description:**

```markdown
## What's New in 0.1.0

### Features
- Added word cloud generation with customizable colors and masks
- Enhanced tag visualization with sequence mapping
- Added comprehensive visualization configuration options

### Documentation
- Added comprehensive CONTRIBUTING.md with development guidelines
- Significantly enhanced README.md with better documentation structure
- Improved user guide documentation

### Bug Fixes
- Fixed image mask handling for word clouds
- Fixed typos and improved code documentation

### Full Changelog
See [CHANGELOG.md](https://github.com/hed-standard/hed-vis/blob/main/CHANGELOG.md)
```

#### 6.3 Attach Build Artifacts

- Upload `dist/hedvis-0.1.0-py3-none-any.whl`
- Upload `dist/hedvis-0.1.0.tar.gz`

#### 6.4 Publish Release

Click **Publish release**

### 7. Post-Release Verification

#### 7.1 Test Installation from PyPI

In a fresh environment:

**All Platforms:**

```bash
pip install --upgrade hedvis
python -c "import hedvis; print(hedvis.__version__)"
```

Expected output: `0.1.0`

#### 7.2 Verify Documentation

Check that documentation sites are updated (may take some time):

- https://www.hedtags.org/hed-vis/ (if applicable)

#### 7.3 Announce the Release

Consider announcing the release:

- [ ] GitHub Discussions
- [ ] HED mailing list
- [ ] Community forums
- [ ] Social media (if applicable)

### 8. Troubleshooting

#### Issue: Wrong version number after tagging

**Problem:** `python -c "import hed; print(hed.__version__)"` shows wrong version

**Solution:**

```bash
# Fetch all tags
git fetch --tags

# Verify tag exists
git tag -l

# Check package version
python -c "import hedvis; print(hedvis.__version__)"
```

#### Issue: Build fails with "No module named X"

**Problem:** Missing dependencies during build

**Solution:**

```bash
# Ensure build tools are installed
pip install --upgrade pip setuptools wheel build

# Try building again
python -m build
```

#### Issue: Upload to PyPI fails with authentication error

**Problem:** Invalid credentials or API token

**Solution:**

- Create a new API token at https://pypi.org/manage/account/token/
- Scope it to the `hedtools` project only
- Use `__token__` as username and the token as password

#### Issue: Tag already exists

**Problem:** You need to delete and recreate a tag

**Solution:**

```bash
# Delete local tag
git tag -d 0.1.0

# Delete remote tag (CAUTION: only if not yet released!)
git push origin :refs/tags/0.1.0

# Recreate the tag
git tag -a 0.1.0 -m "Release version 0.1.0"
git push origin 0.1.0
```

**WARNING:** Only delete remote tags if the release hasn't been published yet!

## Version Numbering Guidelines

HED-Python follows [Semantic Versioning](https://semver.org/):

- **MAJOR version (X.0.0):** Incompatible API changes
- **MINOR version (0.X.0):** New features, backward-compatible
- **PATCH version (0.0.X):** Bug fixes, backward-compatible

### When to increment:

- **MAJOR:** Breaking changes, API redesign, major architectural changes
- **MINOR:** New features, new functions/classes, enhancements (e.g., 0.1.0 → 0.2.0)
- **PATCH:** Bug fixes, documentation fixes, small improvements (e.g., 0.1.0 → 0.1.1)

## Quick Reference Commands

**Windows (PowerShell):**

```powershell
# Complete release workflow
git status                                    # Check working tree
git add CHANGELOG.md pyproject.toml           # Stage changelog and version
git commit -m "Update CHANGELOG for v0.1.0"   # Commit
git push origin main                          # Push to main
git tag -a 0.1.0 -m "Release version 0.1.0"   # Create tag
git push origin 0.1.0                         # Push tag
Remove-Item -Recurse -Force dist, build, *.egg-info -ErrorAction SilentlyContinue
python -m build                               # Build
python -m twine check dist/*                  # Verify
python -m twine upload dist/*                 # Upload
```

**Linux/macOS (Bash):**

```bash
# Complete release workflow
git status                                    # Check working tree
git add CHANGELOG.md pyproject.toml           # Stage changelog and version
git commit -m "Update CHANGELOG for 0.1.0"    # Commit
git push origin main                          # Push to main
git tag -a 0.1.0 -m "Release version 0.1.0"   # Create tag
git push origin 0.1.0                         # Push tag
rm -rf dist build *.egg-info                  # Clean old builds
python -m build                               # Build
python -m twine check dist/*                  # Verify
python -m twine upload dist/*                 # Upload
```

## Additional Resources

- [Python Packaging Guide](https://packaging.python.org/)
- [PyPI Help](https://pypi.org/help/)
- [Semantic Versioning](https://semver.org/)
- [HED Documentation](https://www.hedtags.org/)

## Contacts

For questions about the release process:

- **Maintainer:** Kay Robbins (Kay.Robbins@utsa.edu)
- **Repository:** https://github.com/hed-standard/hed-vis
- **Issues:** https://github.com/hed-standard/hed-vis/issues
